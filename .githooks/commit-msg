#!/bin/bash
# SPDX-License-Identifier: AGPL-3.0-or-later
# casket-ssg commit-msg hook
#
# Validates commit message format
# Install: git config core.hooksPath .githooks

commit_msg_file=$1
commit_msg=$(cat "$commit_msg_file")

# Skip merge commits
if echo "$commit_msg" | grep -q "^Merge"; then
    exit 0
fi

# Conventional commit prefixes
valid_prefixes="feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert"

# Check format: type: description OR type(scope): description
if ! echo "$commit_msg" | head -1 | grep -qE "^($valid_prefixes)(\(.+\))?: .+"; then
    echo "❌ Invalid commit message format"
    echo ""
    echo "Expected: <type>: <description>"
    echo "Or:       <type>(<scope>): <description>"
    echo ""
    echo "Valid types: $valid_prefixes"
    echo ""
    echo "Examples:"
    echo "  feat: Add RSS feed generation"
    echo "  fix(parser): Handle empty frontmatter"
    echo "  docs: Update README with examples"
    echo ""
    exit 1
fi

# Check description length (max 72 chars for first line)
first_line=$(echo "$commit_msg" | head -1)
if [ ${#first_line} -gt 72 ]; then
    echo "⚠️  Commit message first line exceeds 72 characters (${#first_line})"
    echo "Consider shortening for better git log readability"
fi

exit 0
